<div class="legacy-app-container">
  <div class="invoice-container">
  <h1 class="invoice-title">üìÑ Invoice Management</h1>
  
  <!-- Backend Error Display -->
  <div ng-if="vm.error" class="backend-error-container">
    <div class="backend-error-card">
      <div class="error-icon">‚ö†Ô∏è</div>
      <div class="error-content">
        <h3 class="error-title">Unable to Load Data</h3>
        <p class="error-message">{{ vm.error }}</p>
        <div class="error-suggestions">
          <p><strong>Possible causes:</strong></p>
          <ul>
              <li>Backend server is not running</li>
            <li>Network connectivity issues</li>
            <li>Database connection problems</li>
          </ul>
        </div>
        <button ng-click="vm.loadInvoices()" class="retry-button">
          <span class="retry-icon">üîÑ</span>
          Retry Connection
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div ng-if="vm.loading && !vm.error" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Loading invoice data...</p>
  </div>
  
  <!-- Filters and Stats Row -->
  <div ng-if="!vm.error && !vm.loading" class="filters-stats-row">
    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="statusFilter">Status Filter:</label>
        <select id="statusFilter" ng-model="vm.statusFilter" ng-change="vm.loadInvoices()">
          <option value="all">All Invoices</option>
          <option value="paid">Paid</option>
          <option value="unpaid">Unpaid</option>
          <option value="overdue">Overdue</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="searchTerm">Search:</label>
        <input id="searchTerm" type="text" ng-model="vm.searchTerm" placeholder="Client name or invoice number" />
      </div>
    </div>

    <!-- Statistics -->
    <div ng-if="!vm.loading && !vm.error && vm.stats" class="invoice-stats">
      <div class="stat-item">
        <div class="stat-label">Total</div>
        <div class="stat-value stat-total">{{ vm.stats.total }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Paid</div>
        <div class="stat-value stat-paid">{{ vm.stats.paid }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Unpaid</div>
        <div class="stat-value stat-unpaid">{{ vm.stats.unpaid }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Overdue</div>
        <div class="stat-value stat-overdue">{{ vm.stats.overdue }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Amount</div>
        <div class="stat-value stat-amount">{{ vm.formatCurrency(vm.stats.totalAmount) }}</div>
      </div>
    </div>
  </div>

  <!-- React Material Table from mrt_table_app -->
  <react-table-component 
    ng-if="!vm.error && !vm.loading" 
    invoices="vm.filteredInvoicesData"
    on-row-click="vm.selectInvoice(invoice)"
    on-mark-as-paid="vm.markAsPaid(invoice)"
    loading="vm.loading"
    error="vm.error">
  </react-table-component>

  <!-- Invoice Details Popup Modal -->
  <div ng-if="vm.selectedInvoice" class="invoice-popup-overlay" ng-click="vm.closeInvoiceDetails()">
    <div class="invoice-popup" ng-click="$event.stopPropagation()">
      <div class="popup-header">
        <h3 class="popup-title">Invoice Details - {{ vm.selectedInvoice.invoiceNumber }}</h3>
        <button class="popup-close-btn" ng-click="vm.closeInvoiceDetails()" title="Close">
          √ó
        </button>
      </div>
      
      <div class="popup-content">
        <div class="details-grid">
          <div>
            <div class="detail-item">
              <div class="detail-label">Client Name</div>
              <div class="detail-value">{{ vm.selectedInvoice.clientName }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Client Email</div>
              <div class="detail-value">{{ vm.selectedInvoice.clientEmail }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Issue Date</div>
              <div class="detail-value">{{ vm.formatDate(vm.selectedInvoice.issueDate) }}</div>
            </div>
          </div>
          <div>
            <div class="detail-item">
              <div class="detail-label">Due Date</div>
              <div class="detail-value">{{ vm.formatDate(vm.selectedInvoice.dueDate) }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value">
                <span class="badge" ng-class="vm.getStatusClass(vm.selectedInvoice.status)">
                  {{ vm.selectedInvoice.status }}
                </span>
              </div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Total Amount</div>
              <div class="detail-value detail-amount">
                {{ vm.formatCurrency(vm.selectedInvoice.amount) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Invoice Items -->
        <h4 class="items-title">Invoice Items</h4>
        <table class="items-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Quantity</th>
              <th>Unit Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="item in vm.selectedInvoice.items track by $index">
              <td>{{ item.description }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ vm.formatCurrency(item.unitPrice) }}</td>
              <td>{{ vm.formatCurrency(item.total) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="popup-footer">
        <button ng-if="vm.selectedInvoice.status !== 'paid'"
                class="shared-btn"
                ng-click="vm.markAsPaid(vm.selectedInvoice)">
          Mark as Paid
        </button>
        <button class="shared-btn btn-secondary" ng-click="vm.closeInvoiceDetails()">
          Close
        </button>
      </div>
    </div>
  </div>
